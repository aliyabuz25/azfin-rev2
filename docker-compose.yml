version: '3.8'

services:
  db:
    container_name: azfin-mysql
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: azfin_db
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_USER: azfin_user
      MYSQL_PASSWORD: azfin_password
    volumes:
      - /datastore/azfin/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - edge

  azfin-backend:
    container_name: azfin-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PORT: "3001"
      UPLOADS_DIR: "/app/uploads"
      DB_HOST: db
      DB_USER: azfin_user
      DB_PASSWORD: azfin_password
      DB_NAME: azfin_db
    volumes:
      - /datastore/azfin/uploads:/app/uploads
    networks:
      - edge
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=edge'
      - 'traefik.http.routers.azfin-api.rule=(Host(`azfin.az`) || Host(`azfin.octotech.az`)) && (PathPrefix(`/api`) || PathPrefix(`/uploads`))'
      - 'traefik.http.routers.azfin-api.entrypoints=web'
      - 'traefik.http.routers.azfin-api.priority=100'
      - 'traefik.http.services.azfin-api.loadbalancer.server.port=3001'

  azfin-frontend:
    container_name: azfin-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - edge
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=edge'
      - 'traefik.http.routers.azfin.rule=Host(`azfin.az`) || Host(`azfin.octotech.az`)'
      - 'traefik.http.routers.azfin.entrypoints=web'
      - 'traefik.http.services.azfin.loadbalancer.server.port=901'

  phpmyadmin:
    container_name: azfin-phpmyadmin
    image: phpmyadmin:latest
    restart: unless-stopped
    depends_on:
      - db
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_ARBITRARY: 1
      PMA_ABSOLUTE_URI: https://azfin.az/phpmyadmin/
      UPLOAD_LIMIT: 64M
    networks:
      - edge
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=edge'
      - 'traefik.http.routers.pma.rule=(Host(`azfin.az`) || Host(`azfin.octotech.az`)) && PathPrefix(`/phpmyadmin`)'
      - 'traefik.http.routers.pma.entrypoints=web'
      - 'traefik.http.routers.pma.priority=200'
      - 'traefik.http.middlewares.pma-strip.stripprefix.prefixes=/phpmyadmin'
      - 'traefik.http.routers.pma.middlewares=pma-strip'
      - 'traefik.http.services.pma.loadbalancer.server.port=80'

networks:
  edge:
    external: true
